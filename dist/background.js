(()=>{"use strict";class e{static async getVisibleText(e,r){try{const t=e?[{id:e}]:await chrome.tabs.query({active:!0,currentWindow:!0});if(!t||0===t.length||!t[0].id)throw new Error("No active tab found");const o=e=>{try{let r=null;if(r=e?document.querySelector(e):document.querySelector("main")||document.querySelector("#main-content")||document.querySelector(".scaffold-layout__main")||document.querySelector(".application-outlet")||document.body,!r)return console.log("No root element found"),"";const t=r.innerText||r.textContent||"";if(!t)return console.log("No text found in root element"),"";const o=t.replace(/\n{3,}/g,"\n\n").replace(/[ \t]{2,}/g," ").replace(/\s+\n/g,"\n").trim();return console.log(`Extracted ${o.length} characters`),o}catch(e){return console.error("Error in extractTextFromDOM:",e),""}},n=await chrome.scripting.executeScript({target:{tabId:t[0].id},func:o,args:r?[r]:[]});return n&&n[0]&&n[0].result||""}catch(e){throw console.error("Error extracting DOM content:",e),e}}}const r="openai_api_key";class t{static async saveApiKey(e){try{await chrome.storage.local.set({[r]:e}),console.log("API key saved successfully")}catch(e){throw console.error("Error saving API key:",e),new Error("Failed to save API key")}}static async getApiKey(){try{const e=(await chrome.storage.local.get(r))[r];return"string"==typeof e?e:null}catch(e){throw console.error("Error retrieving API key:",e),new Error("Failed to retrieve API key")}}static async clearApiKey(){try{await chrome.storage.local.remove(r),console.log("API key cleared successfully")}catch(e){throw console.error("Error clearing API key:",e),new Error("Failed to clear API key")}}static async hasApiKey(){const e=await this.getApiKey();return null!==e&&e.length>0}}const o={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};let n;const s=new Uint8Array(16),a=[];for(let e=0;e<256;++e)a.push((e+256).toString(16).slice(1));function c(e,r,t){const o=(e=e||{}).random??e.rng?.()??function(){if(!n){if("undefined"==typeof crypto||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");n=crypto.getRandomValues.bind(crypto)}return n(s)}();if(o.length<16)throw new Error("Random bytes length must be >= 16");if(o[6]=15&o[6]|64,o[8]=63&o[8]|128,r){if((t=t||0)<0||t+16>r.length)throw new RangeError(`UUID byte range ${t}:${t+15} is out of buffer bounds`);for(let e=0;e<16;++e)r[t+e]=o[e];return r}return function(e,r=0){return(a[e[r+0]]+a[e[r+1]]+a[e[r+2]]+a[e[r+3]]+"-"+a[e[r+4]]+a[e[r+5]]+"-"+a[e[r+6]]+a[e[r+7]]+"-"+a[e[r+8]]+a[e[r+9]]+"-"+a[e[r+10]]+a[e[r+11]]+a[e[r+12]]+a[e[r+13]]+a[e[r+14]]+a[e[r+15]]).toLowerCase()}(o)}const i="profiles";class l{static async save(e){try{const s=await this.getAllAsMap(),a=e.id||(!o.randomUUID||t||r?c(r,t,n):o.randomUUID()),l=Date.now(),u={id:a,linkedinUrl:e.linkedinUrl||"",name:e.name||"",title:e.title||"",summary:e.summary||"",experience:e.experience||[],education:e.education||[],tags:e.tags||[],rawText:e.rawText||"",createdAt:e.createdAt||l};return s[a]=u,await chrome.storage.local.set({[i]:s}),console.log("Profile saved:",a),u}catch(e){throw console.error("Error saving profile:",e),new Error("Failed to save profile")}var r,t,n}static async getById(e){try{return(await this.getAllAsMap())[e]||null}catch(e){throw console.error("Error retrieving profile:",e),new Error("Failed to retrieve profile")}}static async getAll(){try{const e=await this.getAllAsMap(),r=Object.values(e);return r.sort((e,r)=>r.createdAt-e.createdAt),r}catch(e){throw console.error("Error retrieving all profiles:",e),new Error("Failed to retrieve profiles")}}static async delete(e){try{const r=await this.getAllAsMap();return!!r[e]&&(delete r[e],await chrome.storage.local.set({[i]:r}),console.log("Profile deleted:",e),!0)}catch(e){throw console.error("Error deleting profile:",e),new Error("Failed to delete profile")}}static async deleteAll(){try{await chrome.storage.local.set({[i]:{}}),console.log("All profiles deleted")}catch(e){throw console.error("Error deleting all profiles:",e),new Error("Failed to delete all profiles")}}static async getAllAsMap(){const e=(await chrome.storage.local.get(i))[i];return"object"==typeof e&&null!==e?e:{}}}class u{static async generateCompletion(e,r){const o=await t.getApiKey();if(!o)throw new Error("OpenAI API key not configured");const n={model:r?.model||"gpt-4o-mini",messages:e,temperature:r?.temperature??.7,max_tokens:r?.maxTokens||2e3};try{const e=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o}`},body:JSON.stringify(n)});if(!e.ok){const r=await e.json().catch(()=>({}));throw new Error(`OpenAI API error: ${e.status} - ${r.error?.message||e.statusText}`)}const r=await e.json();if(!r.choices||0===r.choices.length)throw new Error("No completion returned from OpenAI");return{content:r.choices[0].message.content,usage:r.usage?{promptTokens:r.usage.prompt_tokens,completionTokens:r.usage.completion_tokens,totalTokens:r.usage.total_tokens}:void 0}}catch(e){if(console.error("Error calling OpenAI API:",e),e instanceof Error)throw e;throw new Error("Unknown error calling OpenAI API")}}static async generateStructuredData(e,r){const t=[{role:"system",content:"You are a helpful assistant that extracts structured data from text. Always respond with valid JSON only, no additional text or formatting."},{role:"user",content:e}],o=await this.generateCompletion(t,{...r,temperature:.3});try{const e=o.content.match(/\{[\s\S]*\}/),r=e?e[0]:o.content;return JSON.parse(r)}catch(e){throw console.error("Error parsing JSON response:",e),console.error("Raw response:",o.content),new Error("Failed to parse structured data from OpenAI response")}}static async extractProfileData(e){const r=`\nGiven the following text from a LinkedIn profile, extract and structure the following information:\n\n1. Person's full name\n2. Current job title\n3. A brief professional summary (2-3 sentences)\n4. List of work experience entries (company + role)\n5. List of education entries (institution + degree/field)\n6. Generate 5-10 relevant professional skill tags\n\nPlease format the output as a JSON object with these exact keys:\n- name (string)\n- title (string)\n- summary (string)\n- experience (array of strings)\n- education (array of strings)\n- tags (array of strings)\n\nLinkedIn Profile Text:\n${e}\n`;return this.generateStructuredData(r,{maxTokens:2e3})}static async searchProfiles(e,r){const t=`\nGiven the following search query and list of professional profiles, return the IDs of profiles that best match the query, ordered by relevance.\n\nSearch Query: "${e}"\n\nProfiles:\n${JSON.stringify(r,null,2)}\n\nPlease respond with a JSON array of profile IDs, ordered from most to least relevant. Only include profiles that are relevant to the query.\nFormat: ["id1", "id2", "id3", ...]\n`,o=await this.generateStructuredData(t);return Array.isArray(o)?o:[]}}const g="profile_queue";class d{static async enqueue(e){try{const r=await this.getQueue(),t=this.normalizeUrl(e);return r.includes(t)?(console.log("URL already in queue:",t),!1):(r.push(t),await chrome.storage.local.set({[g]:r}),console.log("URL added to queue:",t),!0)}catch(e){throw console.error("Error enqueueing URL:",e),new Error("Failed to enqueue URL")}}static async dequeue(){try{const e=await this.getQueue();if(0===e.length)return null;const r=e.shift();return await chrome.storage.local.set({[g]:e}),console.log("URL dequeued:",r),r}catch(e){throw console.error("Error dequeuing URL:",e),new Error("Failed to dequeue URL")}}static async getQueue(){try{const e=(await chrome.storage.local.get(g))[g];return Array.isArray(e)?e:[]}catch(e){throw console.error("Error getting queue:",e),new Error("Failed to get queue")}}static async clearQueue(){try{await chrome.storage.local.set({[g]:[]}),console.log("Queue cleared")}catch(e){throw console.error("Error clearing queue:",e),new Error("Failed to clear queue")}}static async getQueueSize(){return(await this.getQueue()).length}static async remove(e){try{const r=await this.getQueue(),t=this.normalizeUrl(e),o=r.length,n=r.filter(e=>e!==t);return n.length<o&&(await chrome.storage.local.set({[g]:n}),console.log("URL removed from queue:",t),!0)}catch(e){throw console.error("Error removing URL from queue:",e),new Error("Failed to remove URL from queue")}}static normalizeUrl(e){try{return`https://www.linkedin.com${new URL(e).pathname.replace(/\/$/,"")}`}catch{return e}}}class m{static async enrichProfile(r,t){try{if(!this.isValidLinkedInProfileUrl(r))return{success:!1,error:"Invalid LinkedIn profile URL"};let o,n;console.log("Extracting content from:",r);try{if(o=await e.getVisibleText(t),console.log(`Extracted ${o.length} characters from page`),!o||o.length<50)return console.log("Raw text sample:",o?o.substring(0,200):"none"),{success:!1,error:"Failed to extract sufficient content from page. Please ensure you are on a LinkedIn profile page."}}catch(e){return console.error("DOM extraction error:",e),{success:!1,error:`Failed to extract content from page: ${e instanceof Error?e.message:"Unknown error"}`}}console.log("Processing profile with AI...");try{n=await u.extractProfileData(o)}catch(e){return console.error("AI extraction error:",e),{success:!1,error:e instanceof Error?e.message:"Failed to process profile with AI"}}console.log("Saving profile...");const s={linkedinUrl:r,name:n.name||"Unknown",title:n.title||"",summary:n.summary||"",experience:n.experience||[],education:n.education||[],tags:n.tags||[],rawText:o.substring(0,5e3),createdAt:Date.now()},a=await l.save(s);return console.log("Profile enrichment completed:",a.id),{success:!0,profile:a}}catch(e){return console.error("Unexpected error during profile enrichment:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error during enrichment"}}}static async enrichMultipleProfiles(e){const r=[];for(const t of e){const o=await this.enrichProfile(t);r.push(o),r.length<e.length&&await new Promise(e=>setTimeout(e,1e3))}return r}static isValidLinkedInProfileUrl(e){try{const r=new URL(e);return("www.linkedin.com"===r.hostname||"linkedin.com"===r.hostname)&&r.pathname.startsWith("/in/")}catch{return!1}}}console.log("LinkedIn Profile Harvester background script loaded"),chrome.runtime.onMessage.addListener((r,o,n)=>(console.log("Received message:",r),(async()=>{switch(r.type){case"PING":return{success:!0,message:"pong"};case"EXTRACT_DOM_CONTENT":try{return{success:!0,text:await e.getVisibleText(r.tabId,r.selector)}}catch(e){return{success:!1,message:e instanceof Error?e.message:"Unknown error"}}case"SAVE_API_KEY":try{return await t.saveApiKey(r.apiKey),{success:!0}}catch(e){return{success:!1,message:e instanceof Error?e.message:"Unknown error"}}case"GET_API_KEY":try{return{success:!0,apiKey:await t.getApiKey()}}catch(e){return{success:!1,message:e instanceof Error?e.message:"Unknown error"}}case"HAS_API_KEY":try{return{success:!0,hasKey:await t.hasApiKey()}}catch(e){return{success:!1,message:e instanceof Error?e.message:"Unknown error"}}case"SAVE_PROFILE":try{return{success:!0,profile:await l.save(r.profile)}}catch(e){return{success:!1,message:e instanceof Error?e.message:"Unknown error"}}case"GET_PROFILE":try{return{success:!0,profile:await l.getById(r.id)}}catch(e){return{success:!1,message:e instanceof Error?e.message:"Unknown error"}}case"GET_ALL_PROFILES":try{return{success:!0,profiles:await l.getAll()}}catch(e){return{success:!1,message:e instanceof Error?e.message:"Unknown error"}}case"DELETE_PROFILE":try{return{success:!0,deleted:await l.delete(r.id)}}catch(e){return{success:!1,message:e instanceof Error?e.message:"Unknown error"}}case"ENQUEUE_PROFILE":try{return{success:!0,added:await d.enqueue(r.url)}}catch(e){return{success:!1,message:e instanceof Error?e.message:"Unknown error"}}case"GET_QUEUE":try{return{success:!0,queue:await d.getQueue()}}catch(e){return{success:!1,message:e instanceof Error?e.message:"Unknown error"}}case"ENRICH_PROFILE":try{return await m.enrichProfile(r.url,r.tabId)}catch(e){return{success:!1,error:e instanceof Error?e.message:"Unknown error"}}case"SEARCH_PROFILES":try{const e=await l.getAll(),t=e.map(e=>({id:e.id,name:e.name,title:e.title,summary:e.summary,tags:e.tags}));return{success:!0,profiles:(await u.searchProfiles(r.query,t)).map(r=>e.find(e=>e.id===r)).filter(e=>void 0!==e)}}catch(e){return{success:!1,message:e instanceof Error?e.message:"Unknown error"}}default:return{success:!1,message:"Unknown message type"}}})().then(n).catch(e=>{n({success:!1,message:e instanceof Error?e.message:"Unknown error"})}),!0)),chrome.runtime.onInstalled.addListener(e=>{console.log("Extension installed/updated:",e.reason)})})();